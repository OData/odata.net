steps:
- task: NuGetToolInstaller@0
  inputs:
    versionSpec: '6.5.0'

- task: UseDotNet@2
  inputs:
    version: '8.x'

- task: PowerShell@2
  inputs:
    targetType: 'inline'
    script: |
      # Write your PowerShell commands here.      
      Write-Host "Hello World"
      [System.Reflection.Assembly]::Load("System.EnterpriseServices, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b03f5f7f11d50a3a")
      $publish = New-Object System.EnterpriseServices.Internal.Publish
      $publish.GacInstall("$(gacUtil)")
- task: UseDotNet@2
  inputs:
    version: '8.x'

# .NET Core App 2.1 is required to run the ESRP code signing task
- task: UseDotNet@2
  inputs:
    version: '2.1.x'

- task: DotNetCoreCLI@2
  displayName: 'Build'  
  inputs:
    command: 'build'
    arguments: '--configuration $(BuildConfiguration) --no-incremental'
    projects: |
     $(Build.SourcesDirectory)\sln\OData.sln

# TODO: the original pipeline tested against OData.Pipeline.sln, which includes e2e tests.
# e2e tests failed to run after changes to the solution to support and retargetting to .net8.0 and .net48.
# We should add e2e tests back to the pipeline. See: https://github.com/OData/odata.net/issues/2852
- task: DotNetCoreCLI@2
  displayName: 'Test'
  inputs:
    command: 'test'
    arguments: '--configuration $(BuildConfiguration) --no-build --collect "Code coverage"'
    projects: |      
     $(Build.SourcesDirectory)\sln\OData.sln

# TODO: e2e tests fail to run. We should fix/rewrite e2e tests to support the new target frameworks.
# See: https://github.com/OData/odata.net/issues/2852
# - task: DotNetCoreCLI@2
#   condition: eq(variables.buildConfiguration, 'Release')
#   displayName: 'Test'
#   inputs:
#     command: 'test'
#     arguments: '--configuration $(buildConfiguration) --collect "Code coverage"'
#     projects: |      
#       $(Build.SourcesDirectory)\test\EndToEndTests\Tests\Client\Build.Desktop\Microsoft.Test.OData.Tests.Client.csproj